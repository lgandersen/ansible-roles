---
- name: "Install irc server (ratbox)"
  pkgng:
    name: ircd-ratbox
    state: present

- name: "copy motd file"
  copy:    
    src: "ircd.motd"
    dest: "/usr/local/etc/ircd-ratbox/ircd.motd"
    owner: root

- name: "copy configuration file"
  template:    
    src: "ircd.conf.j2"
    dest: "/usr/local/etc/ircd-ratbox/ircd.conf"
    owner: root

- name: "Generate self-signed certificates"
  command: "openssl req -new -newkey rsa:2048 -sha256 -days 4096 -nodes -x509 -keyout {{ irc_server_name }}.pem -out {{ irc_server_name }}.pem -subj \"/C=US/ST=Some State/L=Narnia /O=/OU=/CN=irc.brobye.dk/emailAddress=\""
  args:
    creates: "/usr/local/etc/ircd-ratbox/{{ irc_server_name }}.pem"
    chdir: /usr/local/etc/ircd-ratbox/

- name: "Check if the symlink '/usr/ports' is present"
  command: "openssl dhparam -out dh.pem 2048"
  args:
    creates: "/usr/local/etc/ircd-ratbox/dh.pem"
    chdir: /usr/local/etc/ircd-ratbox/

- name: "Enable ratbox in rc.conf"
  service:
    name: ircd-ratbox
    enabled: yes
    state: started
